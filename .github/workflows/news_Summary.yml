name: æ–°é—»å¤„ç†æµæ°´çº¿

on:
  workflow_dispatch:
    inputs:
      douyin_url:
        description: 'æŠ–éŸ³è§†é¢‘é“¾æ¥'
        required: true
        type: string
        default: 'https://www.douyin.com/video/example'
      auto_commit:
        description: 'è‡ªåŠ¨æäº¤åˆ°Git'
        required: false
        type: boolean
        default: true
      auto_push:
        description: 'è‡ªåŠ¨æ¨é€åˆ°è¿œç¨‹'
        required: false
        type: boolean
        default: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  news_processing:
    runs-on: ubuntu-latest
    
    steps:
      - name: checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: install
        run: |
          sudo apt update
          sudo apt install -y ffmpeg git

      - name: requirements
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install git+https://github.com/openai/whisper.git

      - name: dir
        run: |
          mkdir -p downloads segments news

      - name: é…ç½®Gitç”¨æˆ·ä¿¡æ¯
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: ç”Ÿæˆç»Ÿä¸€æ—¶é—´æˆ³
        run: |
          timestamp=$(date +"%Y%m%d-%H%M")
          echo "TIMESTAMP=$timestamp" >> $GITHUB_ENV
          echo "æœ¬æ¬¡æµæ°´çº¿æ—¶é—´æˆ³: $timestamp"

      - name: æ­¥éª¤1:ä¸‹è½½æŠ–éŸ³è§†é¢‘
        if: github.event.inputs.douyin_url != ''
        run: |
          echo "å¼€å§‹ä¸‹è½½æŠ–éŸ³è§†é¢‘: ${{ github.event.inputs.douyin_url }}"
          python scripts/douyin_download.py "${{ github.event.inputs.douyin_url }}"

      - name: æ­¥éª¤2:MP4è½¬MP3
        if: github.event.inputs.douyin_url != ''
        run: |
          echo "å¼€å§‹è½¬æ¢MP4ä¸ºMP3..."
          cd downloads
          if [ -f "*.mp4" ]; then
            video=$(ls *.mp4 | head -1)
            echo "è½¬æ¢: $video"
            mp3_name="${video%.mp4}.mp3"
            ffmpeg -i "$video" -vn -acodec libmp3lame -ar 16000 -ac 1 -q:a 2 -y "$mp3_name"
            if [ $? -eq 0 ]; then
              echo "âœ… è½¬æ¢æˆåŠŸ: $mp3_name"
              rm "$video"
              echo "ğŸ§¹ å·²åˆ é™¤: $video"
            else
              echo "âŒ è½¬æ¢å¤±è´¥: $video"
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°MP4æ–‡ä»¶"
          fi
          cd ..

      - name: æ­¥éª¤3:MP3è½¬æ–‡å­—
        if: github.event.inputs.douyin_url != ''
        run: |
          echo "å¼€å§‹è½¬æ¢MP3åˆ°æ–‡å­—..."
          echo "ä½¿ç”¨æ—¶é—´æˆ³: ${{ env.TIMESTAMP }}"
          python scripts/mp3_2_txt.py --timestamp ${{ env.TIMESTAMP }}

      - name: æ­¥éª¤4:AIæ€»ç»“
        if: github.event.inputs.douyin_url != ''
        env:
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
        run: |
          echo "å¼€å§‹ç”ŸæˆAIæ€»ç»“..."
          echo "ä½¿ç”¨æ—¶é—´æˆ³: ${{ env.TIMESTAMP }}"
          python scripts/qwen_news_summary.py --timestamp ${{ env.TIMESTAMP }}

      - name: æ­¥éª¤5:Gitæäº¤
        if: github.event.inputs.auto_commit != false
        run: |
          echo "å¼€å§‹Gitæäº¤..."
          python scripts/git_commit.py

      - name: æ¨é€åˆ°è¿œç¨‹
        if: github.event.inputs.auto_push != false
        run: |
          echo "æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          git push origin HEAD:${{ github.ref }}

      - name: å®ŒæˆæŠ¥å‘Š
        run: |
          echo "ğŸ‰ æ–°é—»å¤„ç†æµæ°´çº¿å®Œæˆï¼"
          echo "æ—¶é—´: $(date)"
          if [ -d "news" ]; then
            echo "ç”Ÿæˆçš„æ–‡ä»¶:"
            ls -la news/

          fi 
